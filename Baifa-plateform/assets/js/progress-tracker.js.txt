// progress-tracker.js
document.addEventListener('DOMContentLoaded', function() {
  // Initialize course progress from localStorage
  loadCourseProgress();
  
  // Add event listeners to course buttons
  document.querySelectorAll('.course-btn').forEach(button => {
    button.addEventListener('click', function(e) {
      const courseName = this.closest('.course-card').querySelector('h3').textContent;
      trackCourseEnrollment(courseName);
    });
  });
  
  // Add event listeners to module completion checkboxes if they exist
  document.querySelectorAll('.module-complete').forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const courseId = this.getAttribute('data-course-id');
      const moduleId = this.getAttribute('data-module-id');
      updateModuleProgress(courseId, moduleId, this.checked);
    });
  });
});

function loadCourseProgress() {
  const progressData = JSON.parse(localStorage.getItem('baifa-course-progress')) || {};
  
  // Update UI with saved progress
  Object.keys(progressData).forEach(courseId => {
    const progress = progressData[courseId];
    const progressElement = document.querySelector(`.course-progress[data-course-id="${courseId}"]`);
    
    if (progressElement) {
      progressElement.style.width = `${progress.percent}%`;
      progressElement.nextElementSibling.textContent = `${progress.percent}%`;
      
      if (progress.percent === 100 && progress.certificate) {
        showCertificateButton(courseId, progress.certificate);
      }
    }
  });
}

function trackCourseEnrollment(courseName) {
  let enrollments = JSON.parse(localStorage.getItem('baifa-course-enrollments')) || [];
  
  if (!enrollments.includes(courseName)) {
    enrollments.push(courseName);
    localStorage.setItem('baifa-course-enrollments', JSON.stringify(enrollments));
    
    // Initialize progress tracking for this course
    const courseProgress = JSON.parse(localStorage.getItem('baifa-course-progress')) || {};
    const courseId = courseName.toLowerCase().replace(/\s+/g, '-');
    
    if (!courseProgress[courseId]) {
      courseProgress[courseId] = {
        name: courseName,
        enrolled: new Date().toISOString(),
        modules: {},
        percent: 0
      };
      localStorage.setItem('baifa-course-progress', JSON.stringify(courseProgress));
    }
  }
}

function updateModuleProgress(courseId, moduleId, completed) {
  const courseProgress = JSON.parse(localStorage.getItem('baifa-course-progress')) || {};
  
  if (!courseProgress[courseId]) {
    courseProgress[courseId] = {
      name: document.querySelector(`[data-course-id="${courseId}"] h3`).textContent,
      enrolled: new Date().toISOString(),
      modules: {},
      percent: 0
    };
  }
  
  if (!courseProgress[courseId].modules) {
    courseProgress[courseId].modules = {};
  }
  
  courseProgress[courseId].modules[moduleId] = {
    completed: completed,
    completedAt: completed ? new Date().toISOString() : null
  };
  
  // Calculate overall progress
  const totalModules = Object.keys(courseProgress[courseId].modules).length;
  const completedModules = Object.values(courseProgress[courseId].modules)
    .filter(module => module.completed).length;
  
  courseProgress[courseId].percent = totalModules > 0 ? 
    Math.round((completedModules / totalModules) * 100) : 0;
  
  // If course is 100% complete, generate certificate
  if (courseProgress[courseId].percent === 100 && !courseProgress[courseId].certificate) {
    courseProgress[courseId].certificate = generateCertificate(courseProgress[courseId].name);
  }
  
  localStorage.setItem('baifa-course-progress', JSON.stringify(courseProgress));
  loadCourseProgress(); // Update UI
}

function generateCertificate(courseName) {
  // Generate a unique certificate ID
  const certId = 'BAIFA-' + Date.now().toString(36).toUpperCase() + '-' + 
    Math.random().toString(36).substr(2, 5).toUpperCase();
  
  // Create certificate data
  const certificate = {
    id: certId,
    course: courseName,
    date: new Date().toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    }),
    issued: new Date().toISOString()
  };
  
  // Store certificate in separate storage
  let certificates = JSON.parse(localStorage.getItem('baifa-certificates')) || [];
  certificates.push(certificate);
  localStorage.setItem('baifa-certificates', JSON.stringify(certificates));
  
  return certificate;
}

function showCertificateButton(courseId, certificate) {
  const container = document.querySelector(`[data-course-id="${courseId}"] .course-actions`);
  if (!container) return;
  
  // Remove any existing certificate buttons
  container.querySelectorAll('.certificate-btn').forEach(btn => btn.remove());
  
  // Create and add certificate button
  const certBtn = document.createElement('button');
  certBtn.className = 'btn certificate-btn';
  certBtn.innerHTML = `<i class="fas fa-certificate"></i> Download Certificate`;
  certBtn.onclick = function() {
    downloadCertificate(certificate);
  };
  
  container.appendChild(certBtn);
}

function downloadCertificate(certificate) {
  // Create a simple certificate HTML
  const certHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>BAIFA Certificate</title>
      <style>
        body { 
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
          text-align: center; 
          padding: 40px;
          background: #f8fafc;
        }
        .certificate {
          max-width: 800px;
          margin: 0 auto;
          background: white;
          padding: 50px;
          border: 2px solid #2563eb;
          border-radius: 10px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .logo {
          width: 150px;
          margin-bottom: 20px;
        }
        h1 {
          color: #2563eb;
          font-size: 2.5rem;
          margin: 20px 0;
        }
        .recipient {
          font-size: 1.8rem;
          margin: 30px 0;
          color: #0f172a;
        }
        .course {
          font-size: 1.5rem;
          margin: 20px 0;
          color: #0d9488;
        }
        .date {
          font-size: 1.1rem;
          margin: 30px 0;
          color: #64748b;
        }
        .cert-id {
          font-size: 0.9rem;
          margin-top: 40px;
          color: #64748b;
        }
        .seal {
          width: 120px;
          height: 120px;
          border: 3px solid #2563eb;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          margin: 30px auto;
          font-weight: bold;
          color: #2563eb;
        }
        @media print {
          body { padding: 0; background: white; }
          .certificate { border: none; box-shadow: none; padding: 20px; }
        }
      </style>
    </head>
    <body>
      <div class="certificate">
        <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='none' stroke='%232563eb' stroke-width='2'/%3E%3Cpath d='M50 20 L65 50 L50 80 L35 50 Z' fill='none' stroke='%232563eb' stroke-width='2'/%3E%3Ctext x='50' y='55' font-family='Arial' font-size='10' fill='%232563eb' text-anchor='middle'%3EBAIFA%3C/text%3E%3C/svg%3E" alt="BAIFA Logo" class="logo">
        <h1>CERTIFICATE OF COMPLETION</h1>
        <p>This certifies that</p>
        <div class="recipient">Learner</div>
        <p>has successfully completed</p>
        <div class="course">${certificate.course}</div>
        <p>on</p>
        <div class="date">${certificate.date}</div>
        <div class="seal">
          <div>OFFICIAL<br>BAIFA<br>CERTIFICATE</div>
        </div>
        <p class="cert-id">Certificate ID: ${certificate.id}</p>
        <p>Verify this certificate at: https://baifa-platform.netlify.app/certificate.html?id=${certificate.id}</p>
      </div>
      <script>
        window.print();
      </script>
    </body>
    </html>
  `;
  
  // Create a new window with the certificate
  const certWindow = window.open('', '_blank');
  certWindow.document.write(certHTML);
  certWindow.document.close();
  
  // Add certificate to user's profile
  const learnerProgress = JSON.parse(localStorage.getItem('baifa-learner-progress')) || {
    certificates: []
  };
  
  learnerProgress.certificates.push({
    id: certificate.id,
    course: certificate.course,
    date: certificate.date,
    verified: true
  });
  
  localStorage.setItem('baifa-learner-progress', JSON.stringify(learnerProgress));
}